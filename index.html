<script>
  async function connectAndPrint() {
    try {
      const serviceUUID = '49535343-fe7d-4ae5-8fa9-9fafd205e455';
      const characteristicUUID = '49535343-8841-43f4-a8d4-ecbe34729bb3';

      let details = "Lorem ipsum dolor sit amet consectetur adipisicing elit. Est repudiandae ratione delectus numquam dicta? Eos magni impedit voluptate deserunt id libero minima. Velit quidem hic eos sit, ullam fuga beatae.\n\n";
      
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [serviceUUID]
      });

      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(serviceUUID);
      const characteristic = await service.getCharacteristic(characteristicUUID);

      const encoder = new TextEncoder();
      const escAlignLeft = '\x1B\x61\x00'; // Align left
      const cutPaper = '\x1D\x56\x00'; // Cut command

      const fullMessage = encoder.encode(escAlignLeft + details + '\n\n' + cutPaper);

      // ðŸ§  CHUNKING
      const CHUNK_SIZE = 180;
      for (let i = 0; i < fullMessage.byteLength; i += CHUNK_SIZE) {
        const chunk = fullMessage.slice(i, i + CHUNK_SIZE);
        await characteristic.writeValue(chunk);
        await new Promise(resolve => setTimeout(resolve, 100)); // small delay
      }

      alert('Printed successfully!');
    } catch (error) {
      console.error(error);
      alert('Printing failed: ' + error.message);
    }
  }
</script>
